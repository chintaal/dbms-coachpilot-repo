# Database Schema Management

## Source of Truth

The database schema is managed through migrations and generated TypeScript types:

- **Migrations**: `supabase/migrations/*.sql`
  - All database schema changes should be captured here
  - Run `npm run sb:pull` to sync changes from Supabase Cloud
  - Migrations are versioned by timestamp

- **Generated Types**: `src/types/supabase.ts`
  - **DO NOT edit this file manually** - it is auto-generated
  - Run `npm run sb:types` to regenerate after schema changes
  - Use `npm run sb:sync` to pull schema and regenerate types in one command

## Workflow

### After making changes in Supabase Cloud Dashboard:

```bash
cd frontend
npm run sb:sync
```

This will:
1. Pull the latest schema from Supabase Cloud (`supabase db pull`)
2. Generate TypeScript types (`supabase gen types typescript --linked`)

### Using Types in Code

Import the `Database` type from the generated types:

```typescript
import { Database } from '@/types/supabase'
import { createClient } from '@/lib/supabase/server'

const supabase = await createClient()
// supabase is now typed with your database schema
```

## RLS-First Approach

- Row Level Security (RLS) is enabled by default
- Always use the `anon` key (via `NEXT_PUBLIC_SUPABASE_ANON_KEY`)
- Never use `service_role` key on the client side
- For privileged operations, use server actions or route handlers

## User-Owned Tables Pattern

Tables that belong to users should follow this pattern:

```sql
create table profiles (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id) not null unique,
  -- other columns...
);

-- Enable RLS
alter table profiles enable row level security;

-- Policy: Users can only see their own profile
create policy "Users can view own profile"
  on profiles for select
  using (auth.uid() = user_id);

-- Policy: Users can only update their own profile
create policy "Users can update own profile"
  on profiles for update
  using (auth.uid() = user_id);
```

This ensures:
- Each row is tied to a user via `user_id`
- RLS policies automatically filter data by `auth.uid()`
- Users can only access their own data
